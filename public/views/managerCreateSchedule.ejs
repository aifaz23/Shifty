<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Schedule</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Custom CSS link -->
    <link rel="stylesheet" type="text/css" href="/css/createSchedule.css">

</head>

<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
        <div class="container-fluid">
            <button class="navbar-toggler flex-grow-sm-1 flex-grow-0 me-2" type="button" data-bs-toggle="collapse"
                data-bs-target=".dual-collapse2">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="navbar-collapse collapse w-100 order-1 order-md-0 dual-collapse2">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="http://localhost:8080/manager/home/<%= id %>"><i
                                class="fa fa-house icon"></i> Home</a>
                    </li>
                    <li class="nav-item dropdown current">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarScrollingDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false"><i class="fa fa-calendar icon"></i> Schedule
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-right" id="drop1"
                            aria-labelledby="navbarScrollingDropdown">
                            <li><a class="dropdown-item" href="http://localhost:8080/manager/createSchedule/<%= id %>"
                                    id="curNei1"><i class="fa-solid fa-calendar-plus icon"></i> Create
                                    Schedule</a></li>
                            <li><a class="dropdown-item" href="http://localhost:8080/manager/editSchedule/<%= id %>"
                                    id="cur"><i class="fa-solid fa-pen-to-square icon"></i> Edit
                                    Schedule</a></li>
                            <li><a class="dropdown-item" href="http://localhost:8080/manager/viewSchedule/<%= id %>"
                                    id="curNei2"><i class="fa fa-eye icon"></i> View Schedule</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="http://localhost:8080/manager/team/<%= id %>"><i
                                class="fa fa-user-group icon"></i> Team</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="http://localhost:8080/manager/shiftChange/<%= id %>"><i
                                class="fas fa-arrow-right-arrow-left icon"></i> Shift Change</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="http://localhost:8080/manager/addEmployee/<%= id %>"
                            id="navbarScrollingDropdown" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false"><i class="fa-solid fa-briefcase icon"></i>
                            Management </a>
                        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-right"
                            aria-labelledby="navbarScrollingDropdown">
                            <li><a class="dropdown-item" href="http://localhost:8080/manager/addEmployee/<%= id %>"><i
                                        class="fa-solid fa-user-plus icon"></i> Add Employee</a></li>
                            <li><a class="dropdown-item"
                                    href="http://localhost:8080/manager/removeEmployee/<%= id %>"><i
                                        class="fa-solid fa-user-minus icon"></i> Remove Employee</a></li>
                        </ul>
                    </li>
                </ul>
            </div>

            <div class="navbar-collapse collapse w-25 order-3 dual-collapse2">
                <ul class="navbar-nav ms-auto buttons">
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <button class="btn btn-sm btn-primary prof-btn" type="submit">My Profile</button>
                        </a>
                    </li>
                    <li class="nav-item">
                        <form id="logoutform" method="post" action="/logout"></form>
                        <a class="nav-link">
                            <button class="btn btn-sm btn-primary log-btn" type="submit" form="logoutform">Log
                                Out</button>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="content">
        <div id="header">
            <h1 class="header">Create Schedule</h1>
        </div>

        <div id="content_body">
            <div class="row">
                <div class="col w-100">
                    <div id="week_selection">
                        <label class="form-label fw-bold" for="week_options">Select a week to create a schedule
                            for:</label>
                        <select name="weeks" id="weeks" class="form-select w-75">
                            <option value="default">
                                Choose the week period
                            </option>
                            <option value='<%= firstWeek %>'>
                                <%= firstWeek %>
                            </option>
                            <option value='<%= secondWeek %>'>
                                <%= secondWeek %>
                            </option>
                        </select>
                    </div>
                </div>
                <div class="col w-100">
                    <div id="select-employee">
                        <label for="nameList" class="form-label fw-bold">Employee to be added to the schedule:</label>
                        <select name="nameList" id="nameList" class="form-select w-75">
                            <option value="default">Choose an employee</option>
                            <% for( let i=0; i < nameList.length; i++ ) { %>
                                <option value='<%= nameList[i] %>'>
                                    <%= nameList[i] %>
                                </option>
                                <% } %>
                        </select>
                    </div>
                </div>
            </div>


            <div id="employee_availability" class="text-center">
                <h2 class="header">Selected employee's current availability:</h2>

                <table class="table table-dark table-bordered" id="avail_table">
                    <thead>
                        <tr>
                            <th style="width: 14.28%;">Sunday</th>
                            <th style="width: 14.28%;">Monday</th>
                            <th style="width: 14.28%;">Tuesday</th>
                            <th style="width: 14.28%;">Wednesday</th>
                            <th style="width: 14.28%;">Thursday</th>
                            <th style="width: 14.28%;">Friday</th>
                            <th style="width: 14.28%;">Saturday</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="sunday"></td>
                            <td id="monday"></td>
                            <td id="tuesday"></td>
                            <td id="wednesday"></td>
                            <td id="thursday"></td>
                            <td id="friday"></td>
                            <td id="saturday"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="schedule_table" class="text-center">
                <table class="table table-dark table-bordered" id="avail_table">
                    <thead>
                        <tr>
                            <th style="width: 14.28%;">Sunday</th>
                            <th style="width: 14.28%;">Monday</th>
                            <th style="width: 14.28%;">Tuesday</th>
                            <th style="width: 14.28%;">Wednesday</th>
                            <th style="width: 14.28%;">Thursday</th>
                            <th style="width: 14.28%;">Friday</th>
                            <th style="width: 14.28%;">Saturday</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="sunday">
                                From
                                <div>
                                    <input type="time" name="sunday_start" id="sunday_start">
                                </div>
                                to
                                <div>
                                    <input type="time" name="sunday_end" id="sunday_end">
                                </div>
                            </td>
                            <td id="monday">
                                From
                                <div>
                                    <input type="time" name="monday_start" id="monday_start">
                                </div>
                                to
                                <div>
                                    <input type="time" name="monday_end" id="monday_end">
                                </div>
                            </td>
                            <td id="tuesday">
                                From
                                <div>
                                    <input type="time" name="tuesday_start" id="tuesday_start">
                                </div>
                                to
                                <div>
                                    <input type="time" name="tuesday_end" id="tuesday_end">
                                </div>
                            </td>
                            <td id="wednesday">
                                From
                                <div>
                                    <input type="time" name="wednesday_start" id="wednesday_start">
                                </div>
                                to
                                <div>
                                    <input type="time" name="wednesday_end" id="wednesday_end">
                                </div>
                            </td>
                            <td id="thursday">
                                From
                                <div>
                                    <input type="time" name="thursday_start" id="thursday_start">
                                </div>
                                to
                                <div>
                                    <input type="time" name="thursday_end" id="thursday_end">
                                </div>
                            </td>
                            <td id="friday">
                                From
                                <div>
                                    <input type="time" name="friday_start" id="friday_start">
                                </div>
                                to
                                <div>
                                    <input type="time" name="friday_end" id="friday_end">
                                </div>
                            </td>
                            <td id="saturday">
                                From
                                <div>
                                    <input type="time" name="saturday_start" id="saturday_start">
                                </div>
                                to
                                <div>
                                    <input type="time" name="saturday_end" id="saturday_end">
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn btn-dark" id="getAvailBtn" onclick="addToSchedule()" disabled>Add to
                    schedule</button>
            </div>

            <hr>

            <div id="final_schedule_preview" class="text-center">
                <h2>Final schedule's preview</h2>
                <table class="table table-dark table-bordered" id="avail_table">
                    <thead>
                        <tr>
                            <th style="width: 12.5%">Employee</th>
                            <th style="width: 12.5%">Sunday</th>
                            <th style="width: 12.5%">Monday</th>
                            <th style="width: 12.5%">Tuesday</th>
                            <th style="width: 12.5%">Wednesday</th>
                            <th style="width: 12.5%">Thursday</th>
                            <th style="width: 12.5%">Friday</th>
                            <th style="width: 12.5%">Saturday</th>
                        </tr>
                    </thead>
                    <tbody id="schedule_body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>

    <!-- Link for using Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
        const nameList = document.querySelector("#nameList");
        const getAvailBtn = document.querySelector('#getAvailBtn');
        let selectedEmployee = null;

        nameList.addEventListener('change', async function () {
            selectedEmployee = nameList.value;
            if (selectedEmployee === "default") {
                getAvailBtn.disabled = true;
                clearAvailabilityTable();
            } else {
                getAvailBtn.disabled = false;
                getAvailability();
            }
        });

        async function getAvailability() {
            clearAvailabilityTable();
            let request = null;
            let firstName = selectedEmployee.split(' ')[0];
            let availability = null;

            try {
                request = await axios.get(`/getAvailability/${firstName}`);
            } catch (error) {
                console.log(error);
            }

            if (request) {
                availability = request.data;

                for (const [key, value] of Object.entries(availability)) {
                    if (value === "allDay") {
                        document.querySelector(`#${key}`).innerHTML = "All Day";
                    } else if (value === "day") {
                        document.querySelector(`#${key}`).innerHTML = "Day";
                    } else {
                        document.querySelector(`#${key}`).innerHTML = "Night";
                    }
                }
            }
        }

        function clearAvailabilityTable() {
            const days = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
            days.forEach(day => {
                document.querySelector(`#${day}`).innerHTML = "";
            });
        }

        async function addToSchedule() {
            const week = document.querySelector('#weeks').value;
            const employee = document.querySelector('#nameList').value;

            const sunday_start = document.querySelector('#sunday_start').value;
            const sunday_end = document.querySelector('#sunday_end').value;

            const monday_start = document.querySelector('#monday_start').value;
            const monday_end = document.querySelector('#monday_end').value;

            const tuesday_start = document.querySelector('#tuesday_start').value;
            const tuesday_end = document.querySelector('#tuesday_end').value;

            const wednesday_start = document.querySelector('#wednesday_start').value;
            const wednesday_end = document.querySelector('#wednesday_end').value;

            const thursday_start = document.querySelector('#thursday_start').value;
            const thursday_end = document.querySelector('#thursday_end').value;

            const friday_start = document.querySelector('#friday_start').value;
            const friday_end = document.querySelector('#friday_end').value;

            const saturday_start = document.querySelector('#saturday_start').value;
            const saturday_end = document.querySelector('#saturday_end').value;

            let data = {
                week: week,
                employee: employee
            };

            if (sunday_start && sunday_end) {
                data.sunday = [sunday_start, sunday_end];
            }

            if (monday_start && monday_end) {
                data.monday = [monday_start, monday_end];
            }

            if (tuesday_start && tuesday_end) {
                data.tuesday = [tuesday_start, tuesday_end];
            }

            if (wednesday_start && wednesday_end) {
                data.wednesday = [wednesday_start, wednesday_end];
            }

            if (thursday_start && thursday_end) {
                data.thursday = [thursday_start, thursday_end];
            }

            if (friday_start && friday_end) {
                data.friday = [friday_start, friday_end];
            }

            if (saturday_start && saturday_end) {
                data.saturday = [saturday_start, saturday_end];
            }

            let request = null;
            try {
                request = await axios.post('/addToSchedule', data);
            } catch (error) {
                alert("Employee is already scheduled for the selected week!");
            }

            if (request) {
                if (request.status === 200) {
                    sunday_start.value = "";
                    sunday_end.value = "";

                    monday_start.value = "";
                    monday_end.value = "";

                    tuesday_start.value = "";
                    tuesday_end.value = "";

                    wednesday_start.value = "";
                    wednesday_end.value = "";

                    thursday_start.value = "";
                    thursday_end.value = "";

                    friday_start.value = "";
                    friday_end.value = "";

                    saturday_start.value = "";
                    saturday_end.value = "";

                    getSchedule(data.employee, data.week);
                }
            }
        }

        async function getSchedule(employee, week) {
            let request = null;
            const data = {
                employee: employee,
                week: week
            }
            try {
                request = await axios.post('/getSchedule', data);
            } catch (error) {
                console.log(error);
            }

            if (request) {
                const data = request.data;
                const name = data.name;
                const schedule_body = document.querySelector('#schedule_body');
                const schedule_row = schedule_body.insertRow();
                const employee = schedule_row.insertCell(0);
                employee.innerHTML = name;

                if ('Sunday' in data) {
                    const sunday = schedule_row.insertCell(1);
                    sunday.innerHTML = `${data.Sunday[0]} to ${data.Sunday[1]}`;
                } else {
                    schedule_row.insertCell(1);
                }
                if ('Monday' in data) {
                    const monday = schedule_row.insertCell(2);
                    monday.innerHTML = `${data.Monday[0]} to ${data.Monday[1]}`;
                } else {
                    schedule_row.insertCell(2);
                }
                if ('Tuesday' in data) {
                    const tuesday = schedule_row.insertCell(3);
                    tuesday.innerHTML = `${data.Tuesday[0]} to ${data.Tuesday[1]}`;
                } else {
                    schedule_row.insertCell(3);
                }
                if ('Wednesday' in data) {
                    const wednesday = schedule_row.insertCell(4);
                    wednesday.innerHTML = `${data.Wednesday[0]} to ${data.Wednesday[1]}`;
                } else {
                    schedule_row.insertCell(4);
                }
                if ('Thursday' in data) {
                    const thursday = schedule_row.insertCell(5);
                    thursday.innerHTML = `${data.Thursday[0]} to ${data.Thursday[1]}`;
                } else {
                    schedule_row.insertCell(5);
                }
                if ('Friday' in data) {
                    const friday = schedule_row.insertCell(6);
                    friday.innerHTML = `${data.Friday[0]} to ${data.Friday[1]}`;
                } else {
                    schedule_row.insertCell(6);
                }
                if ('Saturday' in data) {
                    const saturday = schedule_row.insertCell(7);
                    saturday.innerHTML = `${data.Saturday[0]} to ${data.Saturday[1]}`;
                } else {
                    schedule_row.insertCell(7);
                }
            }
        }
    </script>
</body>

</html>